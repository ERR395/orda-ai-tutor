<script>
        let userName = "";
        let currentSubject = "";

        function startApp() {
            userName = document.getElementById('user-name').value.trim();
            currentSubject = document.getElementById('subject-select').value;
            if(!userName) { alert("Есіміңізді жазыңыз!"); return; }
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            document.getElementById('welcome-text').innerText = "Оқушы: " + userName;
            document.getElementById('current-subject-title').innerText = "| " + currentSubject;
            document.getElementById('editor-label').innerText = currentSubject + " Editor";
            appendMessage('Мұғалім', `Сәлем! ${currentSubject} сабағын бастайық.`, 'bg-white border-l-8 border-orda-gold text-slate-800 shadow-sm');
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const codeInput = document.getElementById('code-area');
            const text = input.value.trim();
            if (!text) return;

            appendMessage('Сіз', text, 'bg-emerald-100 border border-emerald-200 text-emerald-900 ml-6');
            input.value = '';

            try {
                const response = await fetch('https://orda-ai-tutor.onrender.com/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: userName, 
                        message: text, 
                        subject: currentSubject,
                        current_code: codeInput.value 
                    })
                });
                const data = await response.json();
                appendMessage('Мұғалім', data.reply, 'bg-white border-l-8 border-orda-gold text-slate-800 shadow-md');
            } catch (err) {
                appendMessage('Қате', 'Сервермен байланыс жоқ.', 'bg-red-100 text-red-800');
            }
        }

        function appendMessage(sender, text, style) {
            const chatBox = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `${style} p-4 rounded-xl transition-all duration-300`;
            div.innerHTML = `<span class="text-[9px] uppercase font-black block mb-1 opacity-40">${sender}</span> ${text}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- ЕҢ МАҢЫЗДЫ ӨЗГЕРІС ОСЫ ЖЕРДЕ ---
        async function runCode() {
            const code = document.getElementById('code-area').value;
            const output = document.getElementById('output');
            
            if (!code.trim()) { output.innerText = ">>> Код бос!"; return; }
            
            output.innerText = ">>> Орындалуда..."; 
            output.className = "text-yellow-400";

            try {
                // Серверге "ТЕКСЕРУ_РЕЖИМІ" деген құпия сөз жібереміз
                const response = await fetch('https://orda-ai-tutor.onrender.com/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: userName, 
                        message: "ТЕКСЕРУ_РЕЖИМІ",  // Осы сөз арқылы сервер код тексеру екенін біледі
                        subject: currentSubject,
                        current_code: code 
                    })
                });
                const data = await response.json();
                
                // Жауапты тексереміз: '|||' бар ма?
                if (data.reply.includes("|||")) {
                    // ҚАТЕ БОЛҒАНДА
                    const parts = data.reply.split("|||");
                    const terminalError = parts[0].trim(); // Ағылшынша қате
                    const chatExplanation = parts[1].trim(); // Қазақша түсіндірме
                    
                    output.innerText = ">>> ERROR:\n" + terminalError;
                    output.className = "text-red-500 font-bold";
                    
                    // Түсіндірмесін чатқа шығарамыз
                    appendMessage('Мұғалім', `<b>Қате таптым:</b><br>${chatExplanation}`, 'bg-red-50 border-l-8 border-red-500 text-slate-800 shadow-md');
                } else {
                    // ДҰРЫС БОЛҒАНДА (тек терминалға шығады)
                    output.innerText = ">>> НӘТИЖЕ:\n" + data.reply;
                    output.className = "text-green-400";
                    // Чатқа ештеңе жазылмайды!
                }

            } catch (err) {
                output.innerText = ">>> Жүйелік қате (429 болуы мүмкін). Сәл күтіңіз."; 
                output.className = "text-red-500";
            }
        }
        
        document.getElementById('user-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
    </script>
